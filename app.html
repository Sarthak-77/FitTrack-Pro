<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FitTrack Pro - Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>
    <nav class="navbar">
        <a href="app.html" class="brand">FitTrack Pro</a>
        <div class="nav-links">
            <a href="app.html" class="nav-link active">Dashboard</a>
            <a href="activity.html" class="nav-link">Activity Log</a>
            <a href="meals.html" class="nav-link">Meals</a>
            <a href="insights.html" class="nav-link">Insights</a>
        </div>
        <div class="nav-right">
            <div id="live-clock" class="text-muted font-mono">00:00:00</div>
            <a href="profile.html" class="profile-avatar-link" title="Profile">
                <div class="profile-avatar-nav" id="nav-profile-avatar">
                    <span id="nav-avatar-initials">U</span>
                </div>
            </a>
            <a href="#" class="nav-link nav-logout" onclick="logout()" style="color: var(--danger-color);">Logout</a>
        </div>
    </nav>

    <main class="container animate-fade-in">
        <header class="mb-2 flex justify-between items-center">
            <div>
                <h1 id="user-greeting">Hello, User!</h1>
                <p id="username-display" style="color: var(--text-muted); font-size: 0.9rem; margin-top: -0.5rem;"></p>
                <p>Here's your daily wellness overview.</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-muted">Today</p>
                <h3 id="current-date"></h3>
            </div>
        </header>

        <div class="grid grid-3 mt-4">
            <!-- Steps Widget with Chart -->
            <div class="card text-center">
                <h3 style="margin-bottom: 1.5rem;">üö∂ Steps Taken</h3>
                <div class="progress-circle mt-2 mx-auto" style="width: 150px; height: 150px; position: relative;">
                    <canvas id="steps-chart"></canvas>
                    <div
                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <h2 id="step-count"
                            style="font-size: 1.75rem; margin: 0; background: var(--gradient-blue); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                            0</h2>
                        <p class="text-xs text-muted" style="margin: 0;">/ 10,000</p>
                    </div>
                </div>
                <button class="btn btn-secondary mt-2 text-sm" onclick="editSteps()">‚úèÔ∏è Edit</button>
            </div>

            <!-- Calories Widget with Chart -->
            <div class="card text-center">
                <h3 style="margin-bottom: 1.5rem;">üî• Calories Burned</h3>
                <div class="progress-circle mt-2 mx-auto" style="width: 150px; height: 150px; position: relative;">
                    <canvas id="calories-chart"></canvas>
                    <div
                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <h2 id="calorie-count"
                            style="font-size: 1.75rem; margin: 0; background: var(--gradient-orange); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                            0</h2>
                        <p class="text-xs text-muted" style="margin: 0;">kcal</p>
                    </div>
                </div>
                <button class="btn btn-secondary mt-2 text-sm" onclick="editCalories()">‚úèÔ∏è Edit</button>
            </div>

            <!-- Water Widget with Chart -->
            <div class="card text-center">
                <h3 style="margin-bottom: 1.5rem;">üíß Water Intake</h3>
                <div class="progress-circle mt-2 mx-auto" style="width: 150px; height: 150px; position: relative;">
                    <canvas id="water-chart"></canvas>
                    <div
                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
                        <h2 id="water-count"
                            style="font-size: 1.75rem; margin: 0; background: var(--gradient-cyan); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
                            0ml</h2>
                        <p class="text-xs text-muted" style="margin: 0;">/ 2,500ml</p>
                    </div>
                </div>
                <div class="flex gap-2 mt-2 justify-center">
                    <button class="btn btn-secondary text-sm" onclick="addWater()">+ 250ml</button>
                    <button class="btn btn-secondary text-sm" onclick="editWater()">‚úèÔ∏è Edit</button>
                </div>
            </div>
        </div>

        <!-- Weekly Trends Section -->
        <section class="mt-4">
            <h2 class="mb-2">üìà Weekly Trends</h2>
            <div class="card" style="padding: 2rem;">
                <div style="height: 250px; position: relative;">
                    <canvas id="weekly-trend-chart"></canvas>
                </div>
            </div>
        </section>

        <section class="mt-4">
            <h2 class="mb-2">Recent Activity</h2>
            <div id="recent-activities" class="grid grid-2">
                <!-- Populated by JS -->
            </div>
        </section>
    </main>

    <!-- Bottom Navigation (Mobile Only) -->
    <nav class="bottom-nav">
        <a href="app.html" class="bottom-nav-item active">
            <svg viewBox="0 0 24 24">
                <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z" />
            </svg>
            <span>Home</span>
        </a>
        <a href="activity.html" class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path
                    d="M20.38 8.57l-1.23 1.85a8 8 0 0 1-.22 7.58H5.07A8 8 0 0 1 8.8 5.28l.73 1.34 2-3-6.63-1A10 10 0 0 0 1.05 13H0a12 12 0 0 1 22.77-5.53l-2.39 1.1zM7 12a5 5 0 1 1 5 5 5 5 0 0 1-5-5z" />
            </svg>
            <span>Activity</span>
        </a>
        <a href="meals.html" class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path
                    d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z" />
            </svg>
            <span>Meals</span>
        </a>
        <a href="insights.html" class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z" />
            </svg>
            <span>Insights</span>
        </a>
        <a href="profile.html" class="bottom-nav-item">
            <svg viewBox="0 0 24 24">
                <path
                    d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
            </svg>
            <span>Profile</span>
        </a>
    </nav>

    <script src="js/charts.js"></script>
    <script type="module" src="js/supabase.js"></script>
    <script type="module" src="js/data.js"></script>
    <script type="module" src="js/app.js"></script>
    <script type="module" src="js/auth.js"></script>
    <script type="module">
        import { getCurrentUser } from './js/supabase.js';
        import { supabase } from './js/supabase.js';

        // Load user avatar in nav and update greeting
        async function loadNavAvatar() {
            const user = await getCurrentUser();
            if (user) {
                const name = user.user_metadata?.name || user.email.split('@')[0];
                const initials = name
                    .split(' ')
                    .map(n => n[0])
                    .join('')
                    .toUpperCase()
                    .substring(0, 2);
                const avatarEl = document.getElementById('nav-avatar-initials');
                if (avatarEl) {
                    avatarEl.textContent = initials;
                }

                // Update greeting
                const greetingEl = document.getElementById('user-greeting');
                if (greetingEl) {
                    greetingEl.textContent = `Hello, ${name}!`;
                }

                // Load and display username
                const { data: profile } = await supabase
                    .from('profiles')
                    .select('username')
                    .eq('id', user.id)
                    .single();

                const usernameEl = document.getElementById('username-display');
                if (usernameEl && profile?.username) {
                    usernameEl.textContent = `@${profile.username}`;
                }
            }
        }
        loadNavAvatar();
    </script>
    <script>
        document.getElementById('current-date').textContent = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

        // Modal Logic
        let currentEditType = null;

        function openEditModal(type, title, label, placeholder) {
            currentEditType = type;
            document.getElementById('edit-modal').classList.add('active');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-label').textContent = label;
            document.getElementById('edit-input').placeholder = placeholder;
            document.getElementById('edit-input').value = '';
            document.getElementById('edit-input').focus();
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.remove('active');
            currentEditType = null;
        }

        // Close on outside click
        document.getElementById('edit-modal').addEventListener('click', (e) => {
            if (e.target.id === 'edit-modal') closeEditModal();
        });

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('edit-modal').classList.contains('active')) {
                closeEditModal();
            }
        });

        // Handle Save
        document.getElementById('modal-save-btn').addEventListener('click', async () => {
            const value = document.getElementById('edit-input').value;
            if (!value) return;

            const numValue = parseInt(value);
            if (isNaN(numValue) || numValue < 0) {
                alert('Please enter a valid number');
                return;
            }

            try {
                await dataManager.ensureUser();

                if (currentEditType === 'steps') {
                    await dataManager.updateSteps(numValue);
                } else if (currentEditType === 'calories') {
                    await dataManager.updateCalories(numValue);
                } else if (currentEditType === 'water') {
                    await dataManager.setWater(numValue);
                }

                closeEditModal();
                // Refresh page/dashboard to show new values
                // In a full SPA we would just update the DOM, but reloading is safer for now to sync everything
                window.location.reload();
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save: ' + error.message);
            }
        });

        // Enter key to save
        document.getElementById('edit-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') document.getElementById('modal-save-btn').click();
        });

        // Public functions called by buttons
        function editSteps() {
            openEditModal('steps', 'Edit Steps Goal', 'Enter steps count:', '10000');
        }

        function editCalories() {
            openEditModal('calories', 'Edit Calories Burned', 'Enter calories:', '500');
        }

        function editWater() {
            openEditModal('water', 'Edit Water Intake', 'Enter water in ml:', '2500');
        }

        async function addWater() {
            try {
                await dataManager.ensureUser();
                await dataManager.updateWater(250);
                window.location.reload();
            } catch (error) {
                console.error('addWater error:', error);
                alert('Failed to add water: ' + error.message);
            }
        }
    </script>
</body>

<!-- Edit Modal -->
<div id="edit-modal" class="modal-overlay">
    <div class="modal-content glass-effect">
        <div class="modal-header">
            <h3 id="modal-title">Edit Value</h3>
            <button class="modal-close" onclick="closeEditModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <label id="modal-label" for="edit-input">Enter new value:</label>
            <input type="number" id="edit-input" class="modal-input" placeholder="0">
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
            <button class="btn btn-primary" id="modal-save-btn">Save</button>
        </div>
    </div>
</div>
</body>

</html>