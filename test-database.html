<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }

        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background: #2563eb;
        }

        #output {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            white-space: pre-wrap;
            font-family: monospace;
        }
    </style>
</head>

<body>
    <h1>Database Update Test</h1>

    <button onclick="testConnection()">1. Test Connection</button>
    <button onclick="testGetStats()">2. Get Today's Stats</button>
    <button onclick="testUpdateSteps()">3. Test Update Steps</button>
    <button onclick="testDirectUpdate()">4. Test Direct Update</button>

    <div id="output">Click a button to run a test...</div>

    <script type="module">
        import { supabase, getCurrentUser } from './js/supabase.js';

        const output = document.getElementById('output');

        function log(message) {
            output.textContent += message + '\n';
            console.log(message);
        }

        window.testConnection = async function () {
            output.textContent = 'Testing connection...\n';
            try {
                const user = await getCurrentUser();
                if (user) {
                    log('✅ Connected! User: ' + user.email);
                    log('User ID: ' + user.id);
                } else {
                    log('❌ Not logged in');
                }
            } catch (error) {
                log('❌ Error: ' + error.message);
            }
        };

        window.testGetStats = async function () {
            output.textContent = 'Getting today\'s stats...\n';
            try {
                const user = await getCurrentUser();
                if (!user) {
                    log('❌ Not logged in');
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                log('Today: ' + today);

                const { data, error } = await supabase
                    .from('daily_stats')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('date', today)
                    .single();

                if (error) {
                    log('❌ Error: ' + error.message);
                    log('Error details: ' + JSON.stringify(error, null, 2));
                } else {
                    log('✅ Stats found:');
                    log(JSON.stringify(data, null, 2));
                }
            } catch (error) {
                log('❌ Exception: ' + error.message);
            }
        };

        window.testUpdateSteps = async function () {
            output.textContent = 'Testing update steps...\n';
            try {
                const user = await getCurrentUser();
                if (!user) {
                    log('❌ Not logged in');
                    return;
                }

                const today = new Date().toISOString().split('T')[0];
                const newSteps = Math.floor(Math.random() * 10000);
                log('Updating steps to: ' + newSteps);

                const { data, error } = await supabase
                    .from('daily_stats')
                    .update({ steps: newSteps })
                    .eq('user_id', user.id)
                    .eq('date', today)
                    .select();

                if (error) {
                    log('❌ Update Error: ' + error.message);
                    log('Error details: ' + JSON.stringify(error, null, 2));
                } else if (!data || data.length === 0) {
                    log('⚠️ Update returned no data (no rows matched)');
                    log('This means no record exists for today');
                } else {
                    log('✅ Update successful!');
                    log('Updated data: ' + JSON.stringify(data, null, 2));
                }
            } catch (error) {
                log('❌ Exception: ' + error.message);
            }
        };

        window.testDirectUpdate = async function () {
            output.textContent = 'Testing direct SQL update...\n';
            try {
                const user = await getCurrentUser();
                if (!user) {
                    log('❌ Not logged in');
                    return;
                }

                const today = new Date().toISOString().split('T')[0];

                // First, ensure a record exists
                log('Step 1: Ensuring record exists...');
                const { data: existing, error: selectError } = await supabase
                    .from('daily_stats')
                    .select('*')
                    .eq('user_id', user.id)
                    .eq('date', today)
                    .maybeSingle();

                if (selectError) {
                    log('❌ Select Error: ' + selectError.message);
                    return;
                }

                if (!existing) {
                    log('No record found, creating one...');
                    const { error: insertError } = await supabase
                        .from('daily_stats')
                        .insert({
                            user_id: user.id,
                            date: today,
                            steps: 0,
                            calories_burned: 0,
                            water_intake: 0
                        });

                    if (insertError) {
                        log('❌ Insert Error: ' + insertError.message);
                        return;
                    }
                    log('✅ Record created');
                } else {
                    log('✅ Record exists: ' + JSON.stringify(existing, null, 2));
                }

                // Now try to update
                log('\nStep 2: Updating water_intake...');
                const newWater = (existing?.water_intake || 0) + 250;
                log('New water value: ' + newWater);

                const { data: updated, error: updateError } = await supabase
                    .from('daily_stats')
                    .update({ water_intake: newWater })
                    .eq('user_id', user.id)
                    .eq('date', today)
                    .select();

                if (updateError) {
                    log('❌ Update Error: ' + updateError.message);
                    log('Error code: ' + updateError.code);
                    log('Error details: ' + JSON.stringify(updateError, null, 2));
                } else {
                    log('✅ Update successful!');
                    log('Updated data: ' + JSON.stringify(updated, null, 2));
                }
            } catch (error) {
                log('❌ Exception: ' + error.message);
                log('Stack: ' + error.stack);
            }
        };
    </script>
    <script type="module" src="js/supabase.js"></script>
</body>

</html>